<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/css/bootstrap.min.css"
      integrity="sha384-/Y6pD6FV/Vv2HJnA6t+vslU6fwYXjCFtcEpHbNJ0lyAFsXTsjBbfaDjzALeQsN6M"
      crossorigin="anonymous"
    />
    <script
      src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://momentjs.com/downloads/moment.js"
      type="text/javascript"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"
      integrity="sha384-b/U6ypiBEHpOf/4+1nzFpr53nxSS+GLCkfwBdFNTxtclqqenISfwAzpKaMNFNmj4"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta/js/bootstrap.min.js"
      integrity="sha384-h0AbiXch4ZDo7tp9hKZ4TsHbi047NrKGLO3SEJAg45jXxnGIfYzk4Si90RDIqNm1"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
  </head>
  <body>
    <div class="container">
      <br />
      <div class="jumbotron" style="margin-bottom: 8%;">
        <h1 class="display-4">Message App</h1>
        <br />
        <input id="name" class="form-control" placeholder="Họ tên" disabled />
        <br />
        <textarea
          id="message"
          class="form-control"
          placeholder="Nhập tin nhắn tại đây"
        ></textarea>
        <br />
        <button id="send" class="btn btn-success">Gửi</button>
      </div>
      <div id="messages" style="background-color: whitesmoke;
      border-radius: 8px;"></div>
    </div>
    <script>
      var socket = io();
      $(() => {
        let user = localStorage.getItem('user');
        // if(!user){
        //   alert('You must login first');
        //   window.location.replace('http://localhost:5000/auth')
        // }
        user = JSON.parse(user);
        $('#name').attr({
          placeholder: user.full_name,
          value: user.full_name,
        });
        $('#send').click(() => {
          sendMessage({
            user_id: user._id,
            message: $('#message').val(),
          });
          $('#message').val('');
        });
        getMessages();
        socket.on('message', addMessages);
      });
      function hanleTime(time) {
        let different_time = moment().diff(time, 'minutes');
        let checkOverADay = different_time / 24 < 1;
        let result;
        if (!checkOverADay) {
          different_time = Math.round(different_time / 24);
          let day = different_time > 1 ? ' yesterday' : ' days ago';
          result = different_time + day;
        }
        different_time = Math.round(different_time);
        if (different_time < 60 && different_time >= 1) {
          let time = different_time == 1 ? ' minute' : ' minutes';
          result = different_time + time;
        } else if (different_time < 1) result = 'less than 1 minutes';
        else if (different_time > 60) {
          different_time = Math.round(different_time / 60);
          let time = different_time > 1 ? ' hours' : 'hour';
          result = different_time + time;
        }
        result += ' ago';
        return result;
      }
      function addMessages(message) {
        let created_at = message.created_at;
        let result = hanleTime(created_at);
        $('#messages').append(`
      <div class="d-flex justify-content-start" style="display:block; padding:2% 2%;margin-top:-5%">
        <h3 style="color:#2e86de"> ${message.user} </h3>
          <div style="text-align:start, display:block">
            <h4 style="font-weight:300;
                    margin-top: auto;
                    margin-bottom: auto;
                    margin-left: 10px;
                    border-radius: 25px;
                    background-color: #82ccdd;
                    padding: 10px;
                    position: relative;">  
          ${message.message} 
          </h4>
          <p style="font-style:italic"> ${result} </p>
          </div>
       </div>`);
      }

      function getMessages() {
        $.get('http://localhost:5000/conversation/message', (response) => {
          let data = response.data;
          data.forEach(addMessages);
        });
      }

      function sendMessage(message) {
        $.post('http://localhost:5000/conversation/message', message);
      }
    </script>
  </body>
</html>
